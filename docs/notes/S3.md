# AWS S3

---

# 0. 用語の基本（はじめにここだけは押さえる）

- **オブジェクトストレージ**: ファイルを**オブジェクト**（データ本体＋メタデータ＋キー）として保存する仕組み。階層ファイルシステムではなく、**キー（Path 風の文字列）**で識別する。
- **バケット（Bucket）**: オブジェクトを入れる“コンテナ”。**グローバルにユニークな名前**が必要で、**作成リージョン**に紐づく。
- **オブジェクト（Object）**: 実体（ファイル）＋**メタデータ**（Content-Type 等）＋**キー（Key）**。
- **キー（Key）**: オブジェクトの識別子。`photos/2025/10/cat.png` のように**スラッシュを含む文字列**を使うだけで、**フォルダ風**に見せられる。
- **プレフィックス（Prefix）**: キーの先頭部分。`photos/2025/` など。**性能チューニング**（大量リクエスト分散）で登場。
- **リージョン**: バケットを作る物理的エリア。**レイテンシ・法令・コスト**観点で選ぶ。
- **耐久性**: **データが失われない見込み**。S3 は **“イレブンナイン（99.999999999%）”** の耐久性設計が代表。
- **可用性**: **いつでも読める見込み**。S3 はクラスごとに設計が異なる（後述）。
- **強整合性（Strong Consistency）**: **書いた直後に**読み出しても**最新が見える**整合性。S3 は現在、PUT/DELETE/UPDATE に対して**強整合性**。
- **S3 は AZ 非依存**:（一部クラス除く）データは**複数 AZ**に自動的に冗長化されるため、**自分でレプリカ数を意識しない**。

【TIPS】

- 「S3 に**ディレクトリ**は**ない**」→ **キー文字列**で擬似的に表現しているだけ。
- 「**名前重複 NG**のバケット名」「**リージョン**に置く」「**オブジェクトは不変（上書き=新しいバージョン）**」をセットで覚える。

---

# 1. S3 が解決する課題と、他ストレージとの違い

- **S3**: 非構造データ（画像/動画/ログ/バックアップ等）に最適。**スケール・安価・マネージド**。
- **EBS**: EC2 に直結するブロック。**OS や DB のディスク**用途。**単一 AZ**。
- **EFS**: NFS 準拠の共有ファイル。**複数 EC2 で同時マウント**、POSIX 必要なアプリ。
- **FSx**: Windows/NetApp/Lustre 等の**特定ワークロード向け**ファイルシステム。

【頻出シナリオ】

- **静的サイト配信**: S3 + CloudFront（OAC/OAI）
- **データレイク**: S3 + Glue/Athena（スキーマオンリード）
- **バックアップ/アーカイブ**: S3 Intelligent-Tiering / Glacier 系

【落とし穴】

- 「アプリから**ランダム読書き+低遅延**」→ EBS/FS 系を検討。S3 は**HTTP API**で**オブジェクト単位**。

---

# 2. セキュリティとアクセス制御（超重要）

## 2.1 認証・認可の全体像

- **IAM ポリシー**: **誰が S3 に何をできるか**（ユーザー/ロール側）。
- **バケットポリシー**: **バケット側**でアクセス制御（外部アカウントや CloudFront からのアクセス許可など）。
- **ACL（アクセスコントロールリスト）**: 旧来の仕組み。**非推奨**方向。
- **Object Ownership（Bucket owner enforced）**: ACL 無効化＆**バケット所有者を強制的にオブジェクト所有者**に。**推奨設定**。

【TIPS】

- **外部（別アカウント）からのアクセス**は、基本**バケットポリシー**で許可。
- 同一組織でも**複数アカウント**は SAA で頻出 → **クロスアカウント＋バケットポリシー**の構図を描けるように。

## 2.2 公開制御

- **Block Public Access（BPA）**: **アカウント/バケット単位**で**公開無効**を一括制御。**まず BPA オン**が原則。
- **静的サイト公開**が必要な場合でも、**CloudFront 経由（OAC/OAI）**が推奨。**S3 を直接パブリック**は極力避ける。

【落とし穴】

- バケットを公開する**前に**BPA でブロックされていると、**ポリシーが有効でも外部から見えない**。

## 2.3 ネットワーク経路の閉域化

- **VPC エンドポイント**
  - **Gateway 型**（従来）: ルートテーブルに経路追加。安価。
  - **Interface 型**（PrivateLink）: ENI + セキュリティグループで**細かな制御**。**時間課金**あり。
- **S3 Access Points**: バケットの**入口を用途別に分離**。**VPC 限定 AP**も可能（閉域アクセス）。

【TIPS】

- 「**VPC 内からだけ**S3 にアクセスさせたい」→ **Gateway エンドポイント**がまず候補。より厳格なら**Interface 型**も。

## 2.4 暗号化

- **サーバーサイド暗号化（SSE）**
  - **SSE-S3**: S3 管理キー。**最も簡単**。
  - **SSE-KMS**: KMS カスタマー管理キー（CMK/MRK）。**監査/権限分離/鍵ローテ**が必要ならこちら。
  - **SSE-C**: お客様提供鍵。**運用負荷が高い**ため試験では**特殊ケース**。
- **クライアントサイド暗号化**: アップロード前に暗号化。**アプリ側で鍵管理**。

【TIPS】

- **KMS の制限/コスト**を意識（**API リクエスト課金**、スループット制限）。**大量小オブジェクト**なら**S3 Bucket Key**で KMS コスト抑制。
- **SSE-KMS + クロスアカウント複製**は**KMS 許可**（キーの`kms:Decrypt`など）が必要。

## 2.5 監査・可視化

- **CloudTrail**: **S3 管理イベント**（バケット作成など）＋**データイベント**（GetObject/PutObject）。
- **サーバーアクセスログ**: **S3 へのアクセスログ**を別バケットに保存。
- **Access Analyzer for S3**: 公開・外部アクセスの**検出**を自動化。
- **S3 Storage Lens / Inventory**: ストレージ使用状況・オブジェクト一覧を**可視化**。

---

# 3. データ保護（消さない・壊さない）

## 3.1 バージョニング

- **同じキーの新旧履歴**を保持。誤削除・誤上書きから復旧可能。
- **Delete**は**デリートマーカーを追加**（旧バージョンは残る）。

【落とし穴】

- **バージョニング前**に保存されたオブジェクトに対しては、**旧バージョンは存在しない**。

## 3.2 MFA Delete

- **削除/バージョン無効化**に**MFA 要求**。**強力**だが**運用手間**。
- 試験では「**誤削除対策の最強セット** = **バージョニング + MFA Delete**」を覚える。

## 3.3 レプリケーション（SRR/CRR）

- **SRR**（同一リージョン間）/**CRR**（別リージョン間）で**非同期複製**。
- 要件: **両バケットでバージョニング有効**。
- オプション: **削除マーカーの複製**、**既存オブジェクトの一括コピー**、**メタデータ/タグの引継ぎ**など。
- **RTC（Replication Time Control）**: **一定時間内複製の SLA**付き（厳格な RPO 要求向け）。

【落とし穴】

- **SSE-KMS**をレプリケートする場合、**宛先 KMS キーと権限**が必要。
- **双方向レプリケーション**は**ループ**しないよう**レプリケーションルール**に方向制御を。

---

# 4. ストレージクラス（コスト＆アクセス頻度の設計）

> **考え方**: 「**取り出し頻度**」「**復旧スピード**」「**冗長性（AZ 数）**」「**最小保持期間/早期削除ペナルティ**」の 4 点で選ぶ。

## 4.1 主要クラス

- **S3 Standard**
  - 頻繁アクセス。**複数 AZ**冗長。**低レイテンシ**。
  - **デフォルト**。迷ったらここ。
- **S3 Intelligent-Tiering**
  - アクセス頻度に応じて**自動階層化**（頻繁/低頻度/アーカイブ層）。小さな**モニタリング料金**あり。
  - アクセスパターン不明・変動時に ◎。取り出し遅延が許容できるなら**コスト最適化**に強い。
- **S3 Standard-IA**（Infrequent Access）
  - **低頻度**。複数 AZ。**取り出し料金あり**。**最小保持期間（例: 30 日）**に注意。
- **S3 One Zone-IA**
  - **単一 AZ**冗長。**災害で失うリスク**を許容して安価に。**バックアップの二次コピー**など。
- **S3 Glacier Instant Retrieval**
  - まれアクセスだが**ミリ秒取り出し**が必要。**アーカイブ系**で**最短復旧**。
- **S3 Glacier Flexible Retrieval**（旧 Glacier）
  - 取り出し**数分〜数時間**。**アーカイブ**。
- **S3 Glacier Deep Archive**
  - 最安。取り出し**数時間**。**長期保管**（法規制・監査向け）。
- **S3 Express One Zone**
  - **超低遅延・単一 AZ**。メタデータ設計が特殊（**ディレクトリバケット**）。**SAA では優先度低め**だが知識として。

【TIPS】最小保持期間の目安

- Standard-IA/One Zone-IA: **30 日**
- Glacier Instant Retrieval / Flexible Retrieval: **90 日**
- Glacier Deep Archive: **180 日**  
  （※試験では**早期削除ペナルティ**と**取り出し課金**に注意）

## 4.2 クラス選択の早見表

| ニーズ                         | 推奨                       |
| ------------------------------ | -------------------------- |
| パブリック配信・頻繁アクセス   | Standard                   |
| パターン不明/変動              | Intelligent-Tiering        |
| 月 1 回程度の参照              | Standard-IA                |
| 二次バックアップ（災害は許容） | One Zone-IA                |
| アーカイブ、即時復旧           | Glacier Instant Retrieval  |
| アーカイブ、数分〜数時間待てる | Glacier Flexible Retrieval |
| ほぼ取り出しなし・最安         | Glacier Deep Archive       |

【落とし穴】

- **IA 系/Glacier**は**取り出し課金**がある。**大量の一括復元**はコスト爆死注意。
- **Glacier**へ移行しても**オブジェクトキーは S3 のまま**。**復元（Restore）**という操作で一時コピーを**Standard 側に展開**して読む。

---

# 5. データ管理（Lifecycle/ロック/タグ）

## 5.1 ライフサイクルルール

- **Transition**: 期限到来で**別クラスに自動移行**（例: 30 日 →Standard-IA、90 日 →Glacier）。
- **Expiration**: **削除**（例: ログは 180 日で削除）。
- **マルチパート中断の廃棄**: 放置された**未完了パーツの自動削除**。

【TIPS】

- **アクセスログ/アプリログ**は「**30 日で IA、180 日で削除**」が定型。
- **インデックスやマニフェスト**は**削除しない**ように**プレフィックス条件**で丁寧に分岐。

## 5.2 オブジェクトロック（WORM）

- **ガバナンスモード**: 管理者は**特定権限で解除可能**。
- **コンプライアンスモード**: **誰も解除不可**（法規制アーカイブ）。
- **リーガルホールド**: 一時的ロック。
- バケット作成時にロック対応を**有効に**しておく必要がある。

## 5.3 タグ/メタデータ/インベントリ

- **タグ**: 課金配賦（部門/案件）やライフサイクル条件分岐に便利。
- **メタデータ**: Content-Type, Cache-Control など CDN 最適化やアプリ挙動に影響。
- **Inventory**: **定期スナップショット**（CSV/ORC/Parquet）でオブジェクト一覧を吐き出す。
- **Storage Lens**: アカウント/組織横断のダッシュボード化。

---

# 6. パフォーマンスと大規模運用

- **リクエストレート**: 現行 S3 は**プレフィックス分散設計不要**（旧知識）。**自動スケール**。
- **マルチパートアップロード**: **大きなオブジェクト（100MB 超〜）**は**並列化**で高速/堅牢。
- **Range GET**: 断片ダウンロードで**レジューム/並列**が可能。
- **S3 Transfer Acceleration**: **グローバルエッジ**経由で**遠距離アップロード高速化**（専用エンドポイント）。
- **S3 Select**: CSV/JSON/Parquet から**必要列/行だけ抽出**して転送量削減。
- **大量“リネーム”**: S3 は**“キー変更＝コピー＋削除”**。**コスト/時間**に注意。

【TIPS】

- 「**世界からのアップロードが遅い**」→ **Transfer Acceleration** or **CloudFront Upload**パターンを検討。
- 「**TB 級の移行**」→ **AWS Snow Family**や**DataSync**も SAA 頻出。

---

# 7. 配信とネットワーク（静的サイト/CORS/CloudFront）

## 7.1 静的ウェブサイトホスティング

- S3 は**静的**（HTML/CSS/JS/画像）を配信可能。
- ただし**セキュリティ/性能/キャッシュ**最適化のため、**CloudFront**を前段に置くのが**基本**。
- **OAC（Origin Access Control）/OAI（Origin Access Identity）**で**S3 を私有化**し、CloudFront 経由のみ公開。

【TIPS】

- **直接 S3 公開**は取らない前提で覚える（試験も**CloudFront+私有 S3**が模範解答になりやすい）。

## 7.2 CORS

- **ブラウザ JS から S3**（別オリジン）にアクセスする場合は**CORS 設定**。
- **最小権限**のオリジン・メソッド・ヘッダだけ許可。

---

# 8. イベント/サーバーレス連携

- **S3 Event Notifications**: PUT/DELETE 等をトリガに**SNS/SQS/Lambda**へ通知。
- **EventBridge**: より**高機能なイベントルーティング**。
- **S3 Object Lambda**: 取得時に**Lambda で動的変換**（画像サムネ生成/マスキング等）。

【落とし穴】

- **重複イベント**や**順序保証なし**に注意（設計で冪等性を担保）。
- **同一イベントの複数送信先**や**フィルタリング**は仕様差がある（EventBridge の方が柔軟）。

---

# 9. 料金（コストの“落とし穴”をつぶす）

- **課金ポイント**
  - **保存容量**（クラスごとに単価）。
  - **リクエスト数**（PUT/GET/DELETE 等で単価差）。
  - **データ転送**（**リージョン外/インターネット向け**は課金）。
  - **オプション**（Intelligent-Tiering の**モニタリング課金**、**KMS**、**VPC Interface エンドポイント**等）。
- **代表的なコスト最適化**
  - **Intelligent-Tiering**（パターン不明時）
  - **ライフサイクル**で IA/Glacier へ
  - **S3 Bucket Key**で KMS コスト削減
  - **ゲートウェイ VPC エンドポイント**活用（データ転送料金/パス最適）
  - **CloudFront キャッシュ**で S3 の GET 抑制

【TIPS】

- **IA/Glacier**は**取り出し料金**＋**最小保持期間**に注意。**一時的に大量復元**は**見積り**してから。
- **Interface 型 VPC エンドポイント**は**時間課金+データ処理課金**あり。**Gateway 型**より**高くなり得る**。

---

# 10. 試験頻出アーキテクチャ・判断パターン

## 10.1 バックアップ/DR

- **同一リージョンの安価二次保管** → **One Zone-IA**（災害許容できる場合）
- **災害対策（別リージョン）** → **CRR**（RTC の要否は RPO で判断）
- **誤削除対策** → **Versioning + MFA Delete**（最強コンボ）

## 10.2 データレイク/分析

- 生データを**S3 Standard**に → **Glue カタログ**→ **Athena**で SQL 分析。
- **圧縮/列指向（Parquet）**で**コスト/速度**最適化。
- **Storage Lens/Inventory**で棚卸し → 古いデータを**Lifecycle**でアーカイブへ。

## 10.3 静的サイト・コンテンツ配信

- **CloudFront + OAC/OAI + プライベート S3**。
- **署名付き URL/クッキー**で**有料コンテンツの保護**。
- **Cache-Control/Invalidation**で更新戦略。

## 10.4 直アップロード/分散処理

- クライアントは**署名付き URL**で S3 直 PUT → **S3 イベント**で**Lambda/Batch**起動 → サムネ生成/ETL。
- **大量並列**は**マルチパート**と**キューバックプレッシャ**で安定化。

---

# 11. 代表“ひっかけ”と回避 TIPS（SAA 向け）

- **S3 vs EBS/EFS/FSx**: ランダム I/O や POSIX 必要なら**EBS/EFS/FSx**。S3 は**HTTP オブジェクト**。
- **公開方法**: **直公開**ではなく**CloudFront + OAC/OAI**が**模範**。
- **レプリケーション**: **バージョニング必須**。**SSE-KMS**時は**KMS 権限**。**削除マーカー複製**は**オプション**。
- **IA/Glacier**: **取り出し課金/最小保持期間**。
- **誤削除**: **バージョニング + MFA Delete**が最強。
- **閉域アクセス**: **VPC エンドポイント**（Gateway 基本。細かな SG 制御なら Interface）。
- **署名付き URL**: 一時的権限付与（**ダウンロード共有**や**直接アップロード**）。
- **強整合性**: 今は**書いた直後に読める**（旧来の「整合性遅延」は**古い**）。
- **ACL は原則使わない**: **Object Ownership**で**バケット所有者に統一**。

---

# 12. ミニ用語集（試験で迷わない“一言定義”）

- **Bucket**: オブジェクトを入れる器（リージョン単位/名前はグローバル一意）
- **Object**: データ本体＋メタデータ＋キー
- **Key**: オブジェクトの識別文字列（パス風）
- **Prefix**: キーの先頭部分（パフォーマンス/管理で使う）
- **Versioning**: 上書き/削除からの復旧を可能にする履歴管理
- **MFA Delete**: 削除/無効化時に MFA を要求して誤操作防止
- **SRR/CRR**: 同一/別リージョンへの非同期レプリケーション
- **RTC**: レプリケーションの時間 SLA を付与
- **SSE-S3/KMS/C**: S3 管理鍵/KMS 管理鍵/顧客提供鍵
- **Bucket Key**: SSE-KMS 時の KMS リクエスト削減機能
- **Access Point**: 用途別に分離した S3 入口（VPC 限定など）
- **Block Public Access**: 公開をアカウント/バケット単位で一括ブロック
- **Inventory**: 定期のオブジェクト一覧（CSV/ORC/Parquet）
- **Storage Lens**: 使用状況のダッシュボード
- **S3 Select**: オブジェクト内の一部だけ取得して転送量削減
- **Transfer Acceleration**: エッジ経由でアップロード高速化
- **Object Lambda**: GET 時に Lambda で動的変換
- **OAC/OAI**: CloudFront→S3 を私有化するための紐付け

---

# 13. 章末チェック（理解度セルフテスト）

1. **誤削除対策の王道**は？  
   → **Versioning + MFA Delete**

2. **別リージョン DR**で**RPO 短縮**が重要：何を使う？  
   → **CRR + RTC（必要なら）**

3. **外部公開せず配信**したい（CDN 前段）：どう構成？  
   → **CloudFront + OAC/OAI + プライベート S3**

4. **アクセス頻度が読めない**データの保管先は？  
   → **S3 Intelligent-Tiering**

5. **VPC 内限定で S3**にアクセスしたい：何を使う？  
   → **VPC エンドポイント（まず Gateway、要件により Interface）**

6. **KMS 暗号化**で**リクエスト課金が気になる**：対策は？  
   → **S3 Bucket Key**

7. **大量・巨大ファイルを高速に PUT**したい：何を使う？  
   → **マルチパートアップロード**

8. **取り出しは稀だが即時復旧**が必要：どのクラス？  
   → **Glacier Instant Retrieval**

---

# 14. 最後に：学習の進め方（SAA 合格ロードマップ）

1. **用語定義**（本ノート 0 章〜2 章）を声に出して説明できるように。
2. **クラス選定**（4 章）を**「頻度・復旧時間・冗長性・保持期間」**の 4 軸で瞬時に判断。
3. **セキュリティ**（2 章）と**データ保護**（3 章）を**絵に描ける**（IAM/バケポリ/BPA/Versioning/MFA/CRR）。
4. **代表シナリオ**（10 章）を**パターン暗記**。
5. **落とし穴**（11 章）を毎日 5 分復習（IA/Glacier の課金、公開手順、KMS 権限など）。

【ミニ TIPS】

- 問題文に**キーワード**（「**誤削除**」「**閉域**」「**別リージョン**」「**変動アクセス**」「**CDN**」「**KMS コスト**」）が出たら、反射的に**対応パターン**を想起。
- 「**最小コスト**」「**即時復旧**」「**規制準拠**」など、**重視事項**を線で引き、**優先度で絞る**と正答率 UP。

---

_あなたは S3 をもう怖がらなくて OK。用語 → 設計判断 → パターンの順で繰り返し、SAA で確実に点を取りにいきましょう。_
