# AWS EC2

- [AWS EC2](#aws-ec2)
  - [0. 最初に：要点だけ一気読み](#0-最初に要点だけ一気読み)
  - [1. EC2 の基礎と責任共有](#1-ec2-の基礎と責任共有)
  - [2. インスタンス起動の流れ](#2-インスタンス起動の流れ)
    - [2.1 AMI（イメージ）](#21-amiイメージ)
    - [2.2 インスタンスタイプとファミリー](#22-インスタンスタイプとファミリー)
    - [2.3 キーペア（SSH 鍵）](#23-キーペアssh-鍵)
    - [2.4 ネットワーク設定（VPC/AZ）](#24-ネットワーク設定vpcaz)
    - [2.5 ストレージ（EBS vs インスタンスストア）](#25-ストレージebs-vs-インスタンスストア)
    - [2.6 高度な設定（プレイスメント/メタデータ/ユーザーデータ）](#26-高度な設定プレイスメントメタデータユーザーデータ)
  - [3. 購入オプション（コスト最適化）](#3-購入オプションコスト最適化)
  - [4. 可用性・運用・性能設計](#4-可用性運用性能設計)
  - [5. セキュリティ要点](#5-セキュリティ要点)
  - [6. 判断のコツ（ひっかけ回避）](#6-判断のコツひっかけ回避)
  - [7. ミニ問題（SAA レベル想定）](#7-ミニ問題saa-レベル想定)
  - [8. 仕上げチェックリスト](#8-仕上げチェックリスト)

---

## 0. 最初に：要点だけ一気読み

- **EC2 は IaaS**：物理は AWS、OS/ミドル/パッチは**ユーザー責任**。
- **起動の流れ**：AMI → タイプ → キーペア → ネットワーク → ストレージ → 高度設定。
- **ストレージ**：**永続=EBS**／**超高速・一時=インスタンスストア（停止・終了で消える）**。
- **配置**：Cluster/Partition/Spread の**プレイスメントグループ**で性能 or 耐障害性を調整。
- **可用性**：EC2 単体は冗長でない →**ALB + Auto Scaling + マルチ AZ**が基本解。
- **コスト**：短期=オンデマンド、長期=RI or Savings Plans、中断許容=スポット。
- **専有が必要**＝**Dedicated Host/Instance**（コンプライアンス/ライセンス）。
- **IMDSv2 必須化**、**SSM Session Manager**で鍵レス運用が今どきの模範解。

> **試験 TIPS**  
> 設計判断系は「**要件キーワード**→**サービス/機能**」のマッピングを即答できるかが勝負。

---

## 1. EC2 の基礎と責任共有

- **AWS の責任**：データセンター、ハード、仮想化基盤（Nitro）。
- **ユーザーの責任**：OS 更新、ミドル/アプリ設定、インスタンスのセキュリティ、バックアップや監視。

> **試験 TIPS**  
> 「**OS パッチは誰？**」→ ユーザー。  
> 「**ハード障害対応や DC セキュリティは？**」→AWS。

---

## 2. インスタンス起動の流れ

### 2.1 AMI（イメージ）

- **中身**：OS・ミドル・設定のテンプレート。**同じ AMI→ 同じ構成**で複製が容易。
- **入手/作成**：AWS 提供／Marketplace／自作（既存 EC2 から）／**EC2 Image Builder**。
- **共有/コピー**：**リージョン間コピー可**、**別アカウント共有可**（パブリック/プライベート）。

> **試験 TIPS**  
> 「**別リージョンで同一構成を起動**」→**AMI コピー**。  
> 「**他アカウントへ配布**」→**AMI 共有**を連想。

### 2.2 インスタンスタイプとファミリー

- **命名の読み方**：`c7g.large` → c=Compute、7=世代、g=Graviton、large=サイズ。
- **主な用途**
  - 汎用：`t`（**バースト**）、`m`（バランス）
  - 計算：`c` / メモリ：`r` `x` / ストレージ：`i` `d` `h`
  - GPU/高速：`g` `p`、推論/学習特化：`inf` `trn`
  - **Graviton(ARM)**：コスパ良、互換性に注意。

> **試験 TIPS**  
> 「**短時間で安く**」→`t`系（バースト）。  
> 「**CPU 全開・数値計算**」→`c`。  
> 「**インメモリ DB/大容量**」→`r`/`x`。  
> 「**超高速ローカル I/O**」→`i`/`d`（インスタンスストア）。

### 2.3 キーペア（SSH 鍵）

- AWS 側に**公開鍵**、手元に**秘密鍵**。複数インスタンスに同一キーペア OK。
- **秘密鍵は再取得不可**。紛失時は新規キーペアを配布し直す。

> **試験 TIPS**  
> 「**鍵をなくした**」→**再発行できない**。**SSM**で鍵レス運用に誘導されやすい。

### 2.4 ネットワーク設定（VPC/AZ）

- **配置**：VPC、サブネット、AZ を選ぶ。EC2 単体は**冗長化されない**。
- **Elastic IP**：パブリック固定。**未使用/停止中紐付けだと課金**に注意。

> **試験 TIPS**  
> 「**高可用 Web**」→**ALB + Auto Scaling + マルチ AZ**。  
> 「**固定 IP が必要**」→**EIP**（費用条件あり）。

### 2.5 ストレージ（EBS vs インスタンスストア）

- **EBS**：永続ブロック。スナップショット/暗号化/性能クラス（gp/io など）。**停止でもデータ保持**。
- **インスタンスストア**：超高速だが**揮発**（停止・終了・障害で消える）。キャッシュ/一時領域に最適。**再起動では保持**。

> **試験 TIPS**  
> 「**データを残したい**」→**EBS**。  
> 「**最高性能の一時領域が必要**」→**インスタンスストア**。  
> 「**Root の消し忘れ**」→`DeleteOnTermination`設定を問う引っかけに注意。

### 2.6 高度な設定（プレイスメント/メタデータ/ユーザーデータ）

- **プレイスメントグループ**
  - **Cluster**：**単一 AZ・物理近接**→ 低遅延/HPC。可用性より性能。
  - **Partition**：**ラック分離**→ ビッグデータ（HDFS など）に強い。AZ またぎ可。
  - **Spread**：**異なるラックに分散**→**1AZ あたり最大 7 台**、少数だが高耐障害。AZ またぎ可。
- **メタデータ（IMDS）**：`169.254.169.254` から参照。**IMDSv2（トークン）必須化推奨**。
- **ユーザーデータ**：初回ブート時に実行（設定で毎回にもできる）。構成の自動化に使う。

> **試験 TIPS**  
> 「**超低遅延ノード間通信**」→**Cluster**。  
> 「**ラック障害を分離**」→**Partition**。  
> 「**少数台を最大分散**」→**Spread（7 台/1AZ）**。  
> 「**SSRF 対策**」→**IMDSv2 必須**。

---

## 3. 購入オプション（コスト最適化）

- **オンデマンド**：短期・不定期利用。Linux は**秒単位課金**。
- **リザーブドインスタンス（RI）**：1〜3 年コミットで割引。
  - **標準 RI**：構成固定・割引大。
  - **コンバーティブル RI**：途中変更可・割引小。
- **Savings Plans**：時間あたりコミット。**EC2/Lambda/Fargate/SageMaker**に適用するプランあり。柔軟で近年の本命。
- **スポット**：未使用キャパシティを大幅割引。**中断許容**なバッチ/並列向け。
- **専有インスタンス/専有ホスト**：物理分離や**BYOL**などの要件時に使用（高コスト）。

> **試験 TIPS**  
> 「**中断不可で 24/7 稼働**」→**RI or Savings Plans**。  
> 「**最安で並列バッチ**」→**スポット（中断前通知あり）**。  
> 「**物理コア/ソケット単位ライセンス**」→**Dedicated Host**。

---

## 4. 可用性・運用・性能設計

- **可用性**：EC2 単体は冗長でない →**ALB + Auto Scaling + マルチ AZ**。
- **スケーリング**：**Launch Template**推奨（バージョン管理やパラメータ再利用が容易）。
- **性能**：ENA（高性能 NW）、EBS 最適化、インスタンスストア、HPC では EFA。
- **運用**：イミュータブル（**新 AMI でロールアウト**）、`DeleteOnTermination`の挙動を把握。
- **接続**：**SSM Session Manager**で**踏み台/鍵なし**運用がベストプラクティス。

> **試験 TIPS**  
> 「**ASG のテンプレート**」→**Launch Template**。  
> 「**踏み台なく安全に管理**」→**SSM**。

---

## 5. セキュリティ要点

- **セキュリティグループ（SG）**：**ステートフル／許可のみ／ENI 単位**。
- **NACL**：**ステートレス／許可・拒否**両方／**サブネット単位**。
- **EBS 暗号化**：KMS。**スナップショット/AMI 共有時の鍵スコープ**に注意。
- **IMDSv2**：**必須化推奨**（SSRF 対策）。
- **鍵管理**：EC2 の秘密鍵は**再取得不可**。紛失時は別手段（SSM 等）へ。

> **試験 TIPS**  
> 「**SG か NACL か**」は**ステートフル/レス**の違いで判定。  
> 「**メタデータ悪用**」→IMDSv2 で防ぐ。

---

## 6. 判断のコツ（ひっかけ回避）

1. **低遅延ノード間通信**＝**Cluster PG**。
2. **ラック障害に強く**＝**Partition PG**。
3. **少数台を最大分散**＝**Spread PG（1AZ=最大 7 台）**。
4. **永続データ**＝**EBS**、**一時超高速**＝**インスタンスストア**。
5. **中断許容で最安**＝**スポット**。**長期固定**＝**RI/SP**。
6. **ライセンス要件（物理識別）**＝**Dedicated Host**。
7. **高可用 Web**＝**ALB+ASG+マルチ AZ**（EC2 単体は冗長でない）。
8. **鍵レス安全運用**＝**SSM**。
9. **別リージョンに同一構成**＝**AMI コピー**。**別アカウント配布**＝**AMI 共有**。

---

## 7. ミニ問題（SAA レベル想定）

> **Q1**：HPC クラスターでノード間の超低遅延通信が必要。配置は？  
> **A**：**Cluster プレイスメントグループ**（単一 AZ・物理近接）。

> **Q2**：HDFS でラック障害の影響を最小化したい。  
> **A**：**Partition プレイスメントグループ**（ラック分離）。

> **Q3**：短時間の並列バッチ。中断は許容。コスト最小化。  
> **A**：**スポット**（必要台数維持は**スポットフリート**）。

> **Q4**：Windows のソケット/コア単位ライセンスを持ち込みたい。  
> **A**：**Dedicated Host**（物理識別子が見える）。

> **Q5**：Web 二層を高可用にしたい。EC2 は単体で冗長？  
> **A**：**単体は非冗長**。**ALB+ASG でマルチ AZ**。

> **Q6**：ユーザーデータは毎回実行される？  
> **A**：既定は**初回のみ**（設定で毎回に変更可）。

> **Q7**：停止中に EIP を紐づけたまま。料金は？  
> **A**：**課金される場合がある**（未使用/停止中紐付け等）。

> **Q8**：SSRF 対策としてメタデータの安全な使い方は？  
> **A**：**IMDSv2 必須化**。

---

## 8. 仕上げチェックリスト

- [ ] **AMI**：リージョン間コピー／アカウント共有の使い分けを説明できる
- [ ] **タイプ選定**：`t/m/c/r/i/g/p` と **Graviton**の特徴を即答できる
- [ ] **鍵/接続**：秘密鍵は**再取得不可**、**SSM 運用**の利点を語れる
- [ ] **ネットワーク**：EC2 単体は非冗長 →**ALB+ASG+マルチ AZ**が標準解
- [ ] **ストレージ**：**EBS=永続**、**インスタンスストア=一時超高速**をユースケースで切替
- [ ] **プレイスメント**：Cluster/Partition/Spread の**要件 → 選択**を即答
- [ ] **購入オプション**：**オンデマンド/RI/SP/スポット/専有**の判断軸を言語化
- [ ] **セキュリティ**：**SG=ステートフル/許可のみ**、**NACL=ステートレス**の違い
- [ ] **IMDSv2**：必須化の理由（SSRF 対策）を説明できる
- [ ] **運用**：**Launch Template**、イミュータブル更新、`DeleteOnTermination`の挙動

---

> **学習のコツ**  
> 1 問ごとに「**要件キーワード**（低遅延/中断許容/ライセンス/永続/マルチ AZ…）」を赤線 → 即**機能名**を当てる練習。  
> 同じパターンが繰り返し出ます。**語彙対応表**を頭に作ると正答率が一気に上がります。
